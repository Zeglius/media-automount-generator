#!/bin/bash

GENERATOR_DIR="$1"
mkdir -p "$GENERATOR_DIR"

TARGET=default.target
TARGET_DIR="$GENERATOR_DIR/$TARGET.wants"
mkdir -p "$TARGET_DIR"

# Scan partitions
lsblk -nr --filter 'type == "part"' -o PATH,FSTYPE,MOUNTPOINT |
    while read -r path fstype mountpoint; do
        # Skip mounted partitions
        if [[ -n $mountpoint ]]; then
            continue
        fi

        # Skip not supported partitions
        if [[ ${fstype,,} != @(ext4|btrfs) ]]; then
            continue
        fi

        DEVPATH="$path"
        ESCAPED_DEVPATH="$(systemd-escape -p "$DEVPATH")"
        SERVICE_NAME="ublueos-automount@$ESCAPED_DEVPATH.service"
        cat >"$GENERATOR_DIR/$SERVICE_NAME" <<EOF
# Unit generated by $(realpath "$0")
[Unit]
Description=Automount $DEVPATH
BindsTo=$ESCAPED_DEVPATH.device
After=$ESCAPED_DEVPATH.device
SourcePath=$(realpath "$0")
ConditionUser=!@system

[Service]
Type=oneshot
ExecStart=/usr/bin/udisksctl mount -b "$DEVPATH" --no-user-interaction
ExecStop=/usr/bin/udisksctl unmount -b "$DEVPATH" --no-user-interaction
RemainAfterExit=yes
EOF
        # Make the unit start automatically (WantedBy=default.target)
        ln -sf "../$SERVICE_NAME" "$TARGET_DIR/$SERVICE_NAME"

    done
